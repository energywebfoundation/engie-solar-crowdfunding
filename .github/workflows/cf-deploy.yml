name: Deploy to bucket

on:
  push:
    branches: ['develop', 'master', 'release', 'ci/deployments']
jobs:
  cancel-previous:
    name: 'Cancel Previous Runs'
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: styfle/cancel-workflow-action@0.8.0
        with:
          access_token: ${{ github.token }}
  deploy:
    needs: [cancel-previous]
    runs-on: ubuntu-latest
    env: # @TODO - Refactor env if repo is public
        MODE: CI
        NEXT_PUBLIC_UI_BASE_URL: https://esc-dev.energyweb.org
        NEXT_PUBLIC_CHAIN_ID: 73799
        NEXT_PUBLIC_RPC_URL: https://volta-rpc-vkn5r5zx4ke71f9hcu0c.energyweb.org/
        NEXT_PUBLIC_CACHE_SERVER: https://identitycache-dev.energyweb.org/v1
        NEXT_PUBLIC_ORG_NAMESPACE: iam.ewc
        NEXT_PUBLIC_NETWORK_NAME: EnergyWeb Volta Chain
        NEXT_PUBLIC_CURRENCY_NAME: Volta Token
        NEXT_PUBLIC_CURRENCY_SYMBOL: VT
        NEXT_PUBLIC_PATRON_ROLE: email.roles.eea.apps.florin.engietestvolta.iam.ewc
        NEXT_PUBLIC_PATRON_ROLE_VERSION: 1
        NEXT_PUBLIC_TOKEN_LIMIT: 200
        NEXT_PUBLIC_GLOBAL_TOKEN_LIMIT: 10000
        NEXT_PUBLIC_INTEREST_RATE: 10%
        NEXT_PUBLIC_CONTRIBUTION_DEADLINE: "2022-04-16"
        NEXT_PUBLIC_SOLAR_LOANS_DISTRIBUTED: "2022-04-17"
        NEXT_PUBLIC_SOLAR_LOANS_MATURE: "2023-04-17"
        NEXT_PUBLIC_BLOCK_EXPLORER_URL: https://volta-explorer.energyweb.org
        NEXT_PUBLIC_CLAIM_MANAGER_ADDRESS: '0x5339adE9332A604A1c957B9bC1C6eee0Bcf7a031'

    steps:
      - name: Get GHA environment name
        id: env_vars # @TODO - consider production deployments?
        run: |
          echo "Running on branch ${{ github.ref }}"
          if [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "::set-output name=aws_access_key_id::${{ secrets.DEV_AWS_ACCESS_KEY_ID }}"
            echo "::set-output name=aws_secret_key::${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}"
            echo "::set-output name=aws_region::${{ secrets.AWS_REGION }}"
            echo "::set-output name=bucket_name::${{ secrets.DEV_BUCKET_NAME }}"
            echo "::set-output name=cloudfront_id::${{ secrets.DEV_CLOUDFRONT_ID }}"
            echo "::set-output name=next_public_ui_base_url::https://esc-dev.energyweb.org"
            echo "::set-output name=next_public_chain_id::73799"
            echo "::set-output name=next_public_rpc_url::https://volta-rpc-vkn5r5zx4ke71f9hcu0c.energyweb.org/"
            echo "::set-output name=next_public_cache_server::https://identitycache-dev.energyweb.org/v1"
            echo "::set-output name=next_public_org_namespace::iam.ewc"
            echo "::set-output name=next_public_network_name::EnergyWeb Volta Chain"
            echo "::set-output name=next_public_currency_name::Volta Token"
            echo "::set-output name=next_public_currency_symbol::VT"
            echo "::set-output name=next_public_patron_role::email.roles.eea.apps.florin.engietestvolta.iam.ewc"
            echo "::set-output name=next_public_patron_role_version::1"
            echo "::set-output name=next_public_token_limit::200"
            echo "::set-output name=next_public_global_token_limit::10000"
            echo "::set-output name=next_public_interest_rate::10%"
            echo "::set-output name=next_public_contribution_deadline::2022-04-16"
            echo "::set-output name=next_public_solar_loans_distributed::2022-04-17"
            echo "::set-output name=next_public_solar_loans_mature::2022-04-17"
            echo "::set-output name=next_public_block_explorer_url::https://volta-explorer.energyweb.org"
            echo "::set-output name=next_public_claim_manager_address::0x5339adE9332A604A1c957B9bC1C6eee0Bcf7a031"
          elif [ "${{ github.ref }}" = "refs/heads/master" ]; then
            echo "::set-output name=aws_access_key_id::${{ secrets.PROD_AWS_ACCESS_KEY_ID }}"
            echo "::set-output name=aws_secret_key::${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}"
            echo "::set-output name=aws_region::${{ secrets.AWS_REGION }}"
            echo "::set-output name=bucket_name::${{ secrets.PROD_BUCKET_NAME }}"
            echo "::set-output name=cloudfront_id::${{ secrets.PROD_CLOUDFRONT_ID }}"
            echo "::set-output name=next_public_ui_base_url::https://esc.energyweb.org"
            echo "::set-output name=next_public_chain_id::246"
            echo "::set-output name=next_public_rpc_url::https://rpc.energyweb.org"
            echo "::set-output name=next_public_cache_server::https://identitycache.energyweb.org/v1"
            echo "::set-output name=next_public_org_namespace::iam.ewc"
            echo "::set-output name=next_public_network_name::EWC"
            echo "::set-output name=next_public_currency_name::EWT"
            echo "::set-output name=next_public_currency_symbol::EWC"
            echo "::set-output name=next_public_patron_role::email.roles.eea.apps.florin.engietestvolta.iam.ewc"
            echo "::set-output name=next_public_patron_role_version::1"
            echo "::set-output name=next_public_token_limit::200"
            echo "::set-output name=next_public_global_token_limit::10000"
            echo "::set-output name=next_public_interest_rate::10%"
            echo "::set-output name=next_public_contribution_deadline::2022-04-16"
            echo "::set-output name=next_public_solar_loans_distributed::2022-04-17"
            echo "::set-output name=next_public_solar_loans_mature::2022-04-17"
            echo "::set-output name=next_public_block_explorer_url::https://explorer.energyweb.org"
            echo "::set-output name=next_public_claim_manager_address::0x23b026631A6f265d17CFee8aa6ced1B244f3920C"
          else
            echo "Branch ${{ github.ref }} is not configured for deployment"
            exit 1
          fi
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v2-beta
        with:
          node-version: 14.x
          registry-url: https://registry.npmjs.org/
      - name: Cache node modules
        uses: actions/cache@v2
        env:
          cache-name: cache-node-modules
        with:
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-node-
            ${{ runner.os }}-
      - name: Install npm packages
        run: |
          npm install
      - name: Build branch
        run: npm run build:fe
        env:
          NEXT_PUBLIC_UI_BASE_URL: ${{ steps.env_vars.outputs.next_public_ui_base_url }}
          NEXT_PUBLIC_CHAIN_ID: ${{ steps.env_vars.outputs.next_public_chain_id }}
          NEXT_PUBLIC_RPC_URL: ${{ steps.env_vars.outputs.next_public_rpc_url }}
          NEXT_PUBLIC_CACHE_SERVER: ${{ steps.env_vars.outputs.next_public_cache_server }}
          NEXT_PUBLIC_ORG_NAMESPACE: ${{ steps.env_vars.outputs.next_public_org_namespace }}
          NEXT_PUBLIC_NETWORK_NAME: ${{ steps.env_vars.outputs.next_public_network_name }}
          NEXT_PUBLIC_CURRENCY_NAME: ${{ steps.env_vars.outputs.next_public_currency_name }}
          NEXT_PUBLIC_CURRENCY_SYMBOL: ${{ steps.env_vars.outputs.next_public_currency_symbol }}
          NEXT_PUBLIC_PATRON_ROLE: ${{ steps.env_vars.outputs.next_public_patron_role }}
          NEXT_PUBLIC_PATRON_ROLE_VERSION: ${{ steps.env_vars.outputs.next_public_patron_role_version }}
          NEXT_PUBLIC_TOKEN_LIMIT: ${{ steps.env_vars.outputs.next_public_token_limit }}
          NEXT_PUBLIC_GLOBAL_TOKEN_LIMIT: ${{ steps.env_vars.outputs.next_public_global_token_limit }}
          NEXT_PUBLIC_INTEREST_RATE: ${{ steps.env_vars.outputs.next_public_interest_rate }}
          NEXT_PUBLIC_CONTRIBUTION_DEADLINE: ${{ steps.env_vars.outputs.next_public_contribution_deadline }}
          NEXT_PUBLIC_SOLAR_LOANS_DISTRIBUTED: ${{ steps.env_vars.outputs.next_public_solar_loans_distributed }}
          NEXT_PUBLIC_SOLAR_LOANS_MATURE: ${{ steps.env_vars.outputs.next_public_solar_loans_mature }}
          NEXT_PUBLIC_BLOCK_EXPLORER_URL: ${{ steps.env_vars.outputs.next_public_block_explorer_url }}
          NEXT_PUBLIC_CLAIM_MANAGER_ADDRESS: ${{ steps.env_vars.outputs.next_public_claim_manager_address }}
      - name: Ensure dist is present
        run: |
          test -d "dist/apps/ew-crowdfunding/exported" && echo OK || exit 1
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ steps.env_vars.outputs.aws_access_key_id }}
          aws-secret-access-key: ${{ steps.env_vars.outputs.aws_secret_key }}
          aws-region: ${{ steps.env_vars.outputs.aws_region }}
      - name: Clear bucket
        run: |
          aws s3 rm s3://${{ steps.env_vars.outputs.bucket_name }} --recursive
      - name: Upload to bucket
        run: |
          aws s3 cp dist/apps/ew-crowdfunding/exported s3://${{ steps.env_vars.outputs.bucket_name }} --recursive
      - name: Invalidate CloudFront # cloudfront caches s3 content so after each deployment, it needs to be cleared.
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ steps.env_vars.outputs.cloudfront_id }} --paths "/*"
